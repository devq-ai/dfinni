name: Deploy to Cloudflare

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'patient-dashboard/**'
      - '.github/workflows/deploy-cloudflare.yml'

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'

jobs:
  deploy-backend-worker:
    name: Deploy Backend Worker to Cloudflare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Create Worker files
        run: |
          mkdir -p cloudflare-worker
          
          # Create the worker script
          cat > cloudflare-worker/worker.js << 'EOF'
          export default {
            async fetch(request, env) {
              // Get the original URL
              const url = new URL(request.url);
              
              // CORS headers
              const corsHeaders = {
                'Access-Control-Allow-Origin': 'https://devq.ai',
                'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS, PATCH',
                'Access-Control-Allow-Headers': 'Content-Type, Authorization, X-Requested-With',
                'Access-Control-Allow-Credentials': 'true',
                'Access-Control-Max-Age': '86400',
              };

              // Handle CORS preflight
              if (request.method === 'OPTIONS') {
                return new Response(null, { 
                  status: 204,
                  headers: corsHeaders 
                });
              }

              try {
                // Route to your backend running on Mac Studio via Cloudflare Tunnel
                // The tunnel makes your local backend available at db.devq.ai
                const backendUrl = new URL(url.pathname + url.search, 'https://db.devq.ai:8001');
                
                // Forward the request
                const backendResponse = await fetch(backendUrl, {
                  method: request.method,
                  headers: request.headers,
                  body: request.body,
                  // Important: Don't follow redirects automatically
                  redirect: 'manual'
                });

                // Create response with CORS headers
                const response = new Response(backendResponse.body, {
                  status: backendResponse.status,
                  statusText: backendResponse.statusText,
                  headers: backendResponse.headers
                });

                // Add CORS headers
                Object.entries(corsHeaders).forEach(([key, value]) => {
                  response.headers.set(key, value);
                });

                return response;
              } catch (error) {
                console.error('Worker error:', error);
                return new Response(JSON.stringify({ 
                  error: 'Internal Server Error',
                  message: error.message 
                }), {
                  status: 500,
                  headers: {
                    'Content-Type': 'application/json',
                    ...corsHeaders
                  }
                });
              }
            }
          };
          EOF
          
          # Create wrangler.toml
          cat > cloudflare-worker/wrangler.toml << 'EOF'
          name = "pfinni-api"
          main = "worker.js"
          compatibility_date = "2024-01-01"

          [env.production]
          name = "pfinni-api-production"
          routes = [
            { pattern = "api.devq.ai/*", zone_name = "devq.ai" }
          ]

          [env.production.vars]
          ENVIRONMENT = "production"
          EOF
          
      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: cloudflare-worker
          command: deploy --env production

  deploy-frontend-notice:
    name: Frontend Deployment Notice
    runs-on: ubuntu-latest
    steps:
      - name: Notice
        run: |
          echo "â„¹ï¸  Frontend deployment requires server-side rendering due to Clerk authentication."
          echo "â„¹ï¸  Please deploy the frontend to a platform that supports Next.js server-side rendering:"
          echo "    - Vercel (recommended)"
          echo "    - Netlify with Next.js adapter"
          echo "    - Cloudflare Pages with Next.js adapter (experimental)"
          echo ""
          echo "ðŸ“Œ The backend API worker has been deployed to: https://api.devq.ai"